<section class="project-edit">
  <div style="position: relative; bottom: 20px; right: 70px">
    <button
      style="border: none; background: none; font-size: 22px; cursor: pointer"
      (click)="goToDashboard()"
    >
      ⬅️
    </button>
  </div>
  <h2>Modifier le projet</h2>

  <div>
    <label>
      Nom :
      <input type="text" [(ngModel)]="editProject.name" [disabled]="!canModifyProject()" />
    </label>

    <label>
      Date de début :
      <input type="date" [(ngModel)]="editProject.startDate" [disabled]="!canModifyProject()" />
    </label>

    <label>
      Description :
      <textarea
        rows="5"
        [(ngModel)]="editProject.description"
        [disabled]="!canModifyProject()"
      ></textarea>
    </label>

    <hr />
  </div>
  <div>
    <h3>Tâches</h3>
    <ul>
      @for (task of tasks; track $index) {
      <li>
        <strong>{{ task.name }}</strong> — due {{ task.dueDate }} — priority: {{ task.priority }}
        <p>{{ task.description }}</p>
      </li>
      }
      @if (tasks.length === 0) {<li>Pas encore de tâche</li>}
    </ul>

    <h4>Ajouter une tâche</h4>
    @if (canModifyProject()) {<form (ngSubmit)="addTask()">
      <label>
        Nom :
        <input type="text" [(ngModel)]="newTask.name" name="name" required />
      </label>
      <label>
        Description :
        <textarea [(ngModel)]="newTask.description" name="description"></textarea>
      </label>
      <label>
        Date d'échéance :
        <input type="date" [(ngModel)]="newTask.dueDate" name="dueDate" required />
      </label>
      <label>
        Priorité :
        <select [(ngModel)]="newTask.priority" name="priority">
          <option value="LOW">Basse</option>
          <option value="MEDIUM" selected>Moyenne</option>
          <option value="HIGH">Haute</option>
        </select>
      </label>
      <button type="submit">Ajouter</button>
    </form>}
  </div>

  <div>
    <h3>Membres du projet</h3>

    <!-- Affiche la liste, mais boutons suppression cachés pour membres -->
    <ul>
      @for (member of members; track member.id) {
      <li>
        {{ member.user.username }} - {{ member.role }}
        @if (canModifyProject()) {<button
          class="btn-remove-member"
          (click)="removeMember(member.id)"
        >
          ×
        </button>}
      </li>
      }
      @if (members.length === 0) {
      <li>Aucun membre</li>
      }
    </ul>
  </div>

  <!-- Invitation uniquement pour modificateurs -->
  @if (canModifyProject()) {
  <div style="margin-top: 1em">
    <h3>Inviter un membre</h3>
    <div style="display: flex">
      <input
        [(ngModel)]="inviteEmail"
        (ngModelChange)="onInviteEmailChange()"
        [class.input-invalid]="inviteErrorMessage"
        placeholder="Email du membre"
        style="flex-grow: 1"
        type="email"
      />
      <select [(ngModel)]="inviteRole" style="width: 7rem; margin-left: 0.7em">
        <option value="ADMIN">Admin</option>
        <option value="MEMBER">Membre</option>
        <option value="OBSERVER">Observateur</option>
      </select>
      <button
        (click)="inviteMember()"
        [disabled]="!inviteEmail || inviteErrorMessage"
        style="margin-left: 0.7em"
      >
        ➕
      </button>
    </div>
    @if (inviteErrorMessage) {
    <div class="error-message">{{ inviteErrorMessage }}</div>
    }
  </div>
  }

  <div class="actions">
    @if (canModifyProject()) {<button (click)="saveEdit()">Enregistrer</button>} @if
    (canModifyProject()) {<button (click)="deleteProject()">Supprimer</button>}
  </div>
</section>
